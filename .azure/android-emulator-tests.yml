parameters:
- name: 'architecture'
  type: string
  default: ''

steps:
- bash: |
    set -ex
    cd ${{ parameters.architecture }}
    
    # Build individual Android test executables
    make check-android
    
    # List built test executables for verification
    find . -name "*_android" -type f | head -10
  displayName: 'Build Android Test Executables for ${{ parameters.architecture }}'
  workingDirectory: '$(System.DefaultWorkingDirectory)'

- bash: |
    set -ex
    
    # Set up environment for test execution
    export ANDROID_ABI_CMAKE="${{ parameters.architecture }}"
    export BUILD_DIR="build_${{ parameters.architecture }}"
    export PREFIX="${PREFIX}"
    
    # Run the test script
    cd $(Build.SourcesDirectory)/test-android
    ./run-emulator-tests.sh
  displayName: 'Execute Tests in Android Emulator for ${{ parameters.architecture }}'
  workingDirectory: '$(System.DefaultWorkingDirectory)'

- task: PublishTestResults@2
  displayName: 'Publish Android Test Results for ${{ parameters.architecture }}'
  inputs:
    testResultsFormat: 'JUnit'
    testResultsFiles: '$(Build.SourcesDirectory)/test-android/android_test_results.txt'
    testRunTitle: 'FluidSynth Android Tests - ${{ parameters.architecture }}'
  condition: always()